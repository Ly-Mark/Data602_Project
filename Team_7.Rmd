---
title: "Team_7"
author: "Mark Ly"
date: "20/10/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **TITLE** 

<br/>

## **Purpose and Motivation for the project**
<br/>
In this report we will investigate the weight status as measured by the body mass index (BMI) for different populations within the United States of America (USA). Specifically, we would like to examine the proportions of overweight and obese individuals across different ethnic, gender, and age groups. The motivation behind this is to understand if being overweight or obese is linked to the ethnic background, gender, or age of an individual. This would allow programs that attempt to address these health concerns to better target groups most adversely impacted by overweight and obesity. In order to examine these issues, we will be utilizing data gathered from the National Health and Nutrition Examination Survey (NHANES) which is a program under the National Center for Health Statistics (part of the Centers for Disease Control and Prevention or CDC). Further discussion of the underlying data and wrangling procedure is provided in the Data Sets section.

The number of individuals impacted by overweight and obesity is a continued cause for concern as it directly impacts the quality of life and ultimately leads to other health conditions which come with great cost in terms of both individual health and healthcare expenditure. A better understanding of the individuals who are impacted the most by overweight and obesity may assist in appropriate programs to combat these problems with the ultimate goal of improving individual health and reducing the burden on the healthcare system.

In order to evaluate these issues, we will employ different statistical inference methods. A hypothesis test will be conducted comparing the mean BMI of males and females for individuals of different age groups. This will identify if there is an appreciable difference in the average BMI of males and females of the different age ranges; conducting these tests for different age groups reflects that fact that BMI does vary with age. In order to examine whether there is a difference in the proportion of individuals in the different BMI categories across ethnicity, we will utilize a chi-squared test of homogeneity. In conducting these statistical inference procedures, we would ultimately like to understand how BMI varies in different groups across the USA and reflect on potential opportunities for more detailed study. 


## **Data Collection**
<br/><br/>

### **Data Sets** 

The data for this project was obtained from the National Health and Nutrition Examination Survey (NHANES) for years 2015-2016 and 2017-2018. The NHANES program surveys are done to determine the health of the nation by taking a national representative sample of about 5000 persons each year. This survey is an ongoing survey that shows the distribution of health issues within the U.S and allows health planners to see what health problems are affecting the population over time. However, NHANES does over sample a few groups, persons 60 and older, African Americans, and Hispanics. NHANES is a two part survey where there is a questionnaire part and an examination part. We will be making use of both parts for our project. We will be using 2 cycles, 2015 to 2016 and the 2017 to 2018 cycles. In the 2015 to 2016 cycle, we have about 15000 respondents from the ages of <1 year to 80+. 

What we are interested in is the BMI examination data which gives us measurements, such as height(cm), weight(kg), and also calculated BMI ($kg/m^2$). There are other measurements within the BMI examination data that can be used for further analysis.
We will also make use of the demographic data from the questionnaire, to get gender and age. For all NHANES data sets, we will be referring to the code book that is associated with each data set. Within the code book, it tells us how to decipher the data set, what type of values we are dealing with, what each value is coded to and the age range of all participants for that measure. 

### **Data Wrangling**

#### **Base Data set**
To get the data into a usable format for analysis, we will need to perform multiple data wrangling steps as well as making subsets of our data in order to answer our motivational questions. 

1. Import the SAS export files using *SASxport*

2. Using *dplyr* commands (select) to select the variables we are interested in
    + BMI Data (BMX_I, BMI_J)
        + Sequence number, Body measurement completion status, Weight(kg), Height(cm), BMI ($kg/m^2$)
        + Upper leg length(cm), Upper arm length(cm) ,Arm Circumference(cm), Waist Circumference (cm)
    + Demographic Data (DEMO_I, DEMO_J)
        + Sequence number, Gender, Ethnicity, Age
        + Citizenship, Household Size
        
3. Join the BMI data with the Demographic data for each cycle using a left join 
    + SEQN is unique identifier that we can use to join our data sets.
    + We used the *left_join* function in *dplyr* to achieve this. 
    
4. Joining both the cycles together to form one large data set. 
    + Since we are using the same number of columns in the same order, we can use *bind_rows* to concatenate the two data frames
    
5. Checking the join and missing values using the *visdat*
    + 7.4% missing data
    
6. Filtering our data for those who are $\geq20$ and have a complete set of measurements in the BMI data set
    + Using the dplyr filter command, we can perform a filter operation on the Age (RIDAGEYR) and BMI measurement status (BMDSTATS)
    
7. Checking for missing data again using *visdat*

At this point we have a tidy base data base that can be use to create smaller subsets of data for analysis. We started with 19225 individuals over the 2 cycles and after filtering we have 9757 individuals to perform our analysis. At this point we have not renamed our columns because we still need to subset our data.


```{r}

library(SASxport)
library(dplyr)
library(visdat)

# reading the SAS transport file from the NHANES website, combining both data sets from 
# the 2015-2016 survey and the 2017-2018 survey. 
bmi15to16 <-read.xport("BMX_I.xpt")
demo15to16 <-read.xport("DEMO_I.xpt")
bmi17to18 <-read.xport("BMX_J.xpt")
demo17to18 <-read.xport("DEMO_J.xpt")

# selecting variables from the BMI data set for both cycles
bmi15to16 <- dplyr::select(bmi15to16,"SEQN","BMDSTATS",'BMXWT','BMXHT','BMXBMI','BMXLEG',
                           'BMXARML','BMXARMC','BMXWAIST')
bmi17to18 <- dplyr::select(bmi17to18,"SEQN","BMDSTATS",'BMXWT','BMXHT','BMXBMI','BMXLEG',
                           'BMXARML','BMXARMC','BMXWAIST')

# selecting variables from the Demographic data set for both cycles
demo15to16 <- dplyr::select(demo15to16,"SEQN",'RIAGENDR','RIDRETH3','RIDAGEYR',
                            'DMDCITZN','DMDHHSIZ')
demo17to18 <- dplyr::select(demo17to18,"SEQN",'RIAGENDR','RIDRETH3','RIDAGEYR',
                            'DMDCITZN','DMDHHSIZ')

# merging both demographic and BMI data using the "SEQN" unique identifier 
nhanes15to16 <- demo15to16 %>% left_join(bmi15to16, by="SEQN")
nhanes17to18 <- demo17to18 %>% left_join(bmi17to18, by="SEQN")

nhanesBMI <-bind_rows(nhanes15to16,nhanes17to18) # binding both cycles of data into one large data set (19225 rows)

vis_miss(nhanesBMI) # missing data after merging data sets together

# filtering for those who are >=20 and have filled out all the BMI measurements
sortBMI <- nhanesBMI %>% filter(RIDAGEYR >= 20 & BMDSTATS ==1) #9757 rows 

vis_miss(sortBMI) # checking for missing after setting conditions

head(sortBMI) # displaying data set 
```

#### **Sorting by Ethnicity**

One of our questions we are investigating is the proportions of overweight and obese individuals across different ethnic groups. We will need to sub set our main data set by ethnic groups that have been defined in the NHANES data set.

1. Using the *dplyr* filter function and sorting ethnicity into 6 different groups. We created a function (*sortEth*) to do this more efficiently
    + RIDRETH3 is the code for ethnicity in the NHANES demographic data set. It is coded 1-6 depending on the reported ethnicity.
        + 1 = Mexican American (1488 individuals)
        + 2 = Other Hispanic (1113 individuals)
        + 3 = Non-Hispanic White (3299 individuals)
        + 4 = Non-Hispanic Black (2158 individuals)
        + 5 = Non-Hispanic Asian (1286 individuals)
        + 6 = Other Race (Multi-Racial) (413 individuals)
        
2. Next, we have to create a new column to determine their weight status based on their BMI reading. To do this we will be using the *dplyr* command *case_when* and *mutate* to set our bins based on what their BMI number is. We created a function that utilizes this.
    + $<18.5$ = Underweight
    + $18.5$ to $24.9$ = Healthy
    + $25$ to $29.9$ = Overweight
    + $\geq30$ = Obese

3. We need to get the count, mean and standard error for each of our BMI categories for each of our ethnicities. To accomplish this, we will create a function that takes advantage of *dplyr*'s forward pipe (*%>%*), *group_by*, and *summarize* commands
    + We first need to select which data set we want to use
    + Then we will use *group_by* command to group the individuals in our subset by the BMI categories that we set previously
    + We will use the *summarize* to perform operations on our grouped data
        + For count, we will use the *n()* to get the number of observations
        + For mean, can simply use the mean on the BMI column (BMXBMI)
        + For Standard error, we can just take the standard deviation of the BMI column and divide that with the square root of the number of observations

At this moment, we have all the tools to investigate our motivational question regarding BMI and the different ethnic backgrounds in the United States.

```{r}
# Sort ethnicity sorting function. 
sortEth <- function(dataset,val){
    eth <- dataset %>% filter(RIDRETH3 == val)
}

# BMI status 
bmiSort <- function(datSet){
    bmiRa <- datSet%>%
        mutate(bmiRange = case_when(
            BMXBMI <18.5 ~ "Underweight",
            BMXBMI >=18 & BMXBMI <=24.9 ~ "Healthy",
            BMXBMI >=25 & BMXBMI <=29.9 ~ "Overweight",
            BMXBMI >=30 ~"Obese")
            )
}


# function to return count, mean and standard error for each BMI status
bmiStat <- function(datSet){
    datSet %>%
        group_by(bmiRange)%>%
        summarize(
            bmiCount = n(),
            bmiMean = mean(BMXBMI),
            bmiSE = sd(BMXBMI)/sqrt(n())
            )
}

# sorted by Ethnicity 
ethMex <- sortEth(sortBMI,1) # 1488 rows Mexican
ethHisp <- sortEth(sortBMI,2) # 1113 rows Hispanic
ethNW <- sortEth(sortBMI,3) # 3299 rows Non Hispanic White
ethNB <- sortEth(sortBMI,4) # 2158 rows Non Hispanic Black
ethNA <- sortEth(sortBMI,6) # 1286 rows Non Hispanic Asian
ethMW <- sortEth(sortBMI,7) # 413 rows Non Hispanic Multi-Racial

# adding BMI status to each ethnicity 
ethMex <- bmiSort(ethMex)
ethHisp <- bmiSort(ethHisp)
ethNW <- bmiSort(ethNW)
ethNB <- bmiSort(ethNB)
ethNA <- bmiSort(ethNA)
ethMW <- bmiSort(ethMW)

head(ethMex)

# getting count, mean and SE for each category of BMI for each ethnicity
mexStat <- bmiStat(ethMex)
hispStat <- bmiStat(ethHisp)
nwStat <- bmiStat(ethNW)
nbStat <- bmiStat(ethNB)
naStat <- bmiStat(ethNA)
mwStat <- bmiStat(ethMW)

mexStat
```

#### **Sorting by Gender**

The other motivational question we are looking to answer wants to examine the differences between males and females. We will need to create another sub set of our main data base in order to do so. 

1. First we need to sub set our data based on gender using the *filter* function in *dplyr*. From the demographic code book, gender is labeled as RIAGENDR
    + Male is coded as 1 
    + Female is coded as 2
    
2. Next we want to create bins for different age ranges and calculate the BMI for each age range. To do this we can use the *case_when* and *mutate* function from *dplyr* to group by age and store it in a new column.
    + 20 to 39
    + 40 to 59
    + 60+

3. We can borrow the same function in the BMI data set to find the number, count, mean and standard error for males and females. For the total's we can calculate that manually for both genders using the *summarize* function.

```{r}
# Sort Gender function 
sortGen <- function(dataset,val){
    gen <- dataset %>% filter(RIAGENDR == val)
}

# function to return count, mean and standard error for each BMI status
genStat <- function(datSet){
    datSet %>%
        group_by(ageRange)%>%
        summarize(
            bmiCount = n(),
            bmiMean = mean(BMXBMI),
            bmiSE = sd(BMXBMI)/sqrt(n())
            )
}

# Filtering for male and female
maleBMI <- sortGen(sortBMI,1) # 4782 rows
femaleBMI <- sortGen(sortBMI,2) # 4975 rows

# adding age ranges that we want to study 20-39 40-59 60+
maleAgeBMI <- maleBMI %>%
    mutate(ageRange = case_when(
        RIDAGEYR >= 20 & RIDAGEYR <=39~"20-39",
        RIDAGEYR >= 40 & RIDAGEYR <=59~"40-59",
        RIDAGEYR >= 60 ~"60+")
        )

femaleAgeBMI <- femaleBMI %>%
    mutate(ageRange = case_when(
        RIDAGEYR >= 20 & RIDAGEYR <=39~ "20-39",
        RIDAGEYR >= 40 & RIDAGEYR <=59~ "40-59",
        RIDAGEYR >= 60 ~"60+")
        )

head(maleAgeBMI)

# getting count, mean and SE for each category of BMI for each gender based on age range
maleStat <-genStat(maleAgeBMI) 
femaleStat <-genStat(femaleAgeBMI)

# getting count, mean and SE for each category of BMI for each gender
maleStatTotal <- maleAgeBMI %>% summarize(
    count = n(),
    mean = mean(BMXBMI),
    se = sd(BMXBMI)/sqrt(n())
)

femaleStatTotal <- femaleAgeBMI %>% summarize(
    count = n(),
    mean = mean(BMXBMI),
    se = sd(BMXBMI)/sqrt(n())
)

maleStat
```
Now that we have gathered all our data and calculated the relevant statistics, we can begin our analysis of BMI 


## **Statistical Analysis**

### **Hypothesis test**

```{r}
maleStat
femaleStat
maleStatTotal
femaleStatTotal
```
#We will start by doing a Hypothesis Test on whether there is any stastically significant difference in the BMI's of Male's and Females across all age groups over 20. 



```{r}
SampleMeanMales=maleStatTotal$mean  
SampleMeanFemales=femaleStatTotal$mean
print(SampleMeanMales) #display total Sample mean BMI of males
print(SampleMeanFemales) #display total Sample mean BMI of females
diff.BMIs=SampleMeanMales-SampleMeanFemales
print(diff.BMIs) #display the difference
```

#we can see the sample mean BMI of male across all age groups is 29.0404, whereas the sample mean BMI of Female across all age groups is 29.8699. From this, we can see that MaleBMi is  less than Female BMi by 0.8295. To check whether the difference is significant or not we do a two sided test at alpha=0.05.

$H_o : \mu = 0$
$H_a : \mu \neq 0$

#Null hypothesis states that there is no difference between population MeanBMI's of Males and Females.
#Alternative hypothesis states there is a difference between population MeanBMI's of Males and Females.

#Conditions for Hypothesis Test: Difference Between Means
#Meets the Independence condition as the two samples of Male and Female are independent of each other. They are less than 10% of their respective gender population.
#Both the samples are randomly collected.
#Population distributions of BMI for each gender are right skewed. To nullify this higher sample sizes are taken.

```{r}
Maleage.BMIsample=maleageBMI %>% select(BMXBMI) #selecting BMI's of males 
Femaleage.BMIsample=femaleAgeBMI  %>% select(BMXBMI) #selecting BMi's of females
t.test(x=Maleage.BMIsample, y=Femaleage.BMIsample,alternative = "two.sided")
```

#From the test results we can see that with a low p-value of 1.979e-09, which is way less than alpha at 0.05, we can strongly reject the null hypothesis in favor of alternate hypothesis which states that there is a difference between population MeanBMI's of Males and Females. We are 95 percent confident the range of population mean BMI of Males is lower than Females by (0.5587, 1.1003).

#To check whether Male BMI is lower than Female BMI consistently across all age groups or a particular age group is influencing this result and to find out how difference in BMI is varying with increase in age. We will start looking into each age group from here on


#Age-group 60+

```{r}
SampleMeanMales=maleStat[3,3]
SampleMeanFemales=femaleStat[3,3]
print(SampleMeanMales)#display Sample mean BMI of males over 60
print(SampleMeanFemales)#display Sample mean BMI of female over 60
diff.BMIs60=SampleMeanMales-SampleMeanFemales
print(diff.BMIs60)#display their difference
```
#we can see the sample mean BMI of male for ages over 60 is 28.7643, whereas the sample mean BMI of Female for ages over 60 is  29.7068 From this, we can see that MaleBMi is  less than Female BMi by 0.9424. To check whether the difference is significant or not we do a two sided test at alpha=0.05.

$H_o : \mu = 0$
$H_a : \mu \neq 0$

#Null hypothesis states that there is no difference between population MeanBMI's of Males and Females for ages over 60.
#Alternative hypothesis states there is a difference between population MeanBMI's of Males and Females for ages over 60.

#Conditions for Hypothesis Test: Difference Between Means
#Meets the Independence condition as the two samples of Male and Female for this particular age groupnare independent of each other. They are less than 10% of their respective gender population.
#Both the samples are randomly collected.
#Population distributions of BMI  for each gender for this particular age group might be slightly right skewed . To nullify this higher sample sizes are taken.

```{r}
Maleage.BMIsample=maleageBMI %>% filter(ageRange=="60+") %>% select(BMXBMI) #selecting BMI's of Males over 60
Femaleage.BMIsample=femaleAgeBMI %>% filter(ageRange=="60+") %>% select(BMXBMI) #selecting BMI's of Females over 60
t.test(x=Maleage.BMIsample, y=Femaleage.BMIsample,alternative = "two.sided")

```
#From the test results we can see that with a low p-value of 5.205e-06, which is way less than alpha at 0.05, we can strongly reject the null hypothesis in favor of alternate hypothesis which states that there is a difference between population MeanBMI's of Males and Females for senior citizens. For ages over 60, We are 95 percent confident that the range of population mean BMI of Males is lower than Females by (0.5375, 1.3473).



#Conclusion
#From our four Hypothesis tests we can see that female BMI is higher than Male BMI across all age groups above 20+.
#As our sample sizes are roughly costant around 1600 for each age group the highest difference is observed in the ------ group.
#These results can be useful in the field of drug discovery where drugs are discovered for a disease which effects both men and women.
#Dieticians can use these results to specifically design diets on the basis of gender and their age group.

### **Test of homogeneity**

In order to examine whether the proportion of individuals in each BMI category are consistent across different ethnic backgrounds, we will conduct a test of homogeneity using a chi-squared test. The populations under analysis are the representative groups from which the sample participants were selected; individuals of Mexican American, other Hispanic, Non-Hispanic White, Non-Hispanic Black, Non-Hispanic Asian, and other(multi-racial) ethnicity. 

BMI is categorized into the following categories: underweight, healthy, overweight, and obese. These categorizations are based on BMI values of less than 18.5, 18.5-24.9, 25-29.9 and 30 and over respectively. We hope to examine whether the proportion of individuals in each category are consistent across different ethnic groups, and if not, this may provide grounds for further research into what is driving these differences as well as targeting programs appropriately to assist those populations struggling with overweight and obesity.	

```{r}
#creating a data frame consisting of the individuals in each BMI category by ethnicity
ethnicity_df = rbind(ethMex[,c(3,15)],ethHisp[,c(3,15)])
ethnicity_df = rbind(ethnicity_df,ethNW[,c(3,15)])
ethnicity_df = rbind(ethnicity_df,ethNB[,c(3,15)])
ethnicity_df = rbind(ethnicity_df,ethNA[,c(3,15)])
ethnicity_df = rbind(ethnicity_df,ethMW[,c(3,15)])

#convertinf above data frame into table required to run the chi-squared test
ethnicity_tbl = table(ethnicity_df$RIDRETH3,ethnicity_df$bmiRange)
rownames(ethnicity_tbl) = c("Mexican American", "Other Hispanic", "Non-Hispanic White",
                            "Non-Hispanic Black", "Non-Hispanic Asian", "Other Race (Multi Racial)")
print(ethnicity_tbl)
```


The above table indicates the number of individuals who fall into each BMI category, grouped by ethnicity. This is the initial contingency table from which the chi-squared test of homogeneity will be conducted. As we are examining the samples in order to see whether there is a significant difference in the number of people in each BMI category across the six ethnic groups we will setup the null and alternative hypothesis as follows:

$H_o:$ The proportion of individuals in each of the four BMI categories is the same across the six ethnic groups.

$H_a:$ The proportion of individuals in each of the four BMI categories is not the same across the six ethnic groups.


We have elected to use a 5% level of significance in conducting this test.

```{r}
#calculations to manually setup chi-square test are based on slide 8 and 9 of Dr. Chen's 
#Week 4 - II lecture notes presented October 5, 2021
expected = as.array(margin.table(ethnicity_tbl,1)) %*% t(as.array(margin.table(ethnicity_tbl,2)))/
    margin.table(ethnicity_tbl)
cellcontributions = (as.array(ethnicity_tbl)-expected)^2/expected
chi_square = round(sum(cellcontributions),4)
pval = round(1- pchisq(chi_square,4),4)
cat("Chisquare =", chi_square, ", ","P-value =", pval, "\n")

#using built-in chi-square function
chisq.test(ethnicity_tbl)
```


The above results show both the manual calculation and using the built-in chisq.test() function yield a test statistic of `r chi_square` and p-value of `r pval`. Since the p-value is extremely small and far less than the 5% level of significance, we strongly reject the null hypothesis that proportion of individuals in each of the four BMI categories is the same across the six ethnic groups.

In order to gain further insight into this result, we will examine the expected values based on the contingency table values along with the Pearson residuals ($\frac{observed-expected}{\sqrt{expected}}$).


```{r}
chisq.test(ethnicity_tbl)$expected
```


```{r}
chisq.test(ethnicity_tbl)$residuals
```


The table above demonstrates that the largest residuals come from Non-Hispanic Asians in both the healthy and obese categories. As the value in the healthy weight category is large and positive this indicates that the Non-Hispanic Asian population has a greater proportion of individuals in the healthy category and the large negative under obesity indicates a lower proportion of their population falls in the obese category as compared with the expected values of the contingency table. The next largest residuals are from the Mexican American group, in this case it appears that a their population has a greater proportion of individuals in the obese category and a smaller proportion in the healthy category. In order to get a better sense of the above data, we will generate a mosaic plot in order to represent this information visually:


```{r}
rownames(ethnicity_tbl) = c("Mex Amer", "Oth Hisp", "NH Wht",
                            "NH Blk", "NH Asn", "Other")
mosaicplot(ethnicity_tbl, shade=TRUE, main = "BMI Category vs Ethnicity",
               xlab = "Ethnicity", ylab = "BMI Weight Category",las = 1)
```


The mosaic plot condenses a considerable amount of information into a single plot. We can see the relative proportions of individuals in each category by ethnicity as well as the magnitude of the Pearson residuals through the colors (as specified in the legend). In the context of this sample, it appears that the Mexican American and Other Hispanic groups have a lower proportion of individuals in the healthy category while Non-Hispanic Asians have a lower proportion of obese. Conversely, the Mexican American and Non-Hispanic Black groups have a greater proportion of obese individuals while Non-Hispanic Asians have a greater proportion of healthy individuals.


If we are to draw conclusions on the underlying population from the NHANES sample data, we would infer that the proportion of individuals in each of the four BMI categories is different across the six ethnic groups of the study. Examining the contributions of each group via the observed and expected values and the resulting residuals indicates that populations disproportionately affected by obesity are the Mexican American and Non-Hispanic Black ethnic groups. In regards to the less severe overweight category we see that the Mexican American, Other Hispanic, and Other (Multi-Racial) ethnicity are disproportionately affected. 

This result would indicate that further research may be necessary in order to determine the underlying factors which put these populations at greater risk. Certain factors such as income, education levels, access to social services and others may be driving these disparities. By better understanding the underlying causes that contribute to greater proportions of overweight and obese individuals, governments may better address the root causes and thus improve the overall health of the population and reduce the strain on medical resources.


Ethnicity                 | Underweight  | Healthy | Overweight | Obese |
--------------------------|-------|------| --------|----------- |-------|
Mexican American          | 0.1   | 0.0  |   -2    |     4      |  0.4  | 
Other Hispanic            | 0.2   | 0.2  |   -1    |     1      |  0.2  | 
Non-Hispanic White        | 0.4   | 0.8  |    0    |     0      |  0.2  | 
Non-Hispanic Black        | 0.2   | 0.6  |    1    |     1      |  0.2  | 
Non-Hispanic Asian        | 0.1   | 0.4  |    2    |     4      |  0.2  | 
Other Race (Multi Racial) | 11    | 11   |    1    |     5      |  0.2  | 



```{r}
mexStat
hispStat
nwStat
nbStat
naStat
mwStat
```

## **Conclusion**




## **References**




